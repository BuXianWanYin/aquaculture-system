# 前后端权限联动说明

## 一、权限控制架构

### 后端权限控制
- **注解方式**：使用 `@RequiresPermission({"permission:code"})` 注解
- **权限代码**：基于权限代码字符串（如 `system:user:view`、`plan:add` 等）
- **权限来源**：从数据库 `sys_permission` 表查询，通过 `sys_role_permission` 关联到角色
- **拦截器**：`AuthInterceptor` 在请求时加载用户权限列表到 request 中
- **切面**：`PermissionAspect` 检查用户是否拥有所需权限

### 前端权限控制
- **Composable**：使用 `usePermission()` 获取权限判断函数
- **权限来源**：从后端登录接口返回的 `UserDTO.permissions` 数组
- **判断方式**：通过 `hasPermission('permission:code')` 检查权限代码

## 二、权限数据流转

### 1. 登录流程
```
用户登录 
  → 后端验证账号密码
  → 查询用户角色
  → 查询角色对应的权限列表（sys_role_permission + sys_permission）
  → 返回 UserDTO（包含 permissions 数组）
  → 前端保存到 userStore.userInfo.permissions
```

### 2. 权限校验流程

#### 后端校验
```
请求到达 
  → AuthInterceptor 拦截
  → 从 JWT token 获取 userId 和 roleId
  → 查询角色对应的权限列表
  → 存储到 request.attribute("permissions")
  → PermissionAspect 拦截 @RequiresPermission 注解
  → 检查 request 中的权限列表是否包含所需权限
  → 通过则继续，否则返回 403
```

#### 前端校验
```
页面渲染
  → usePermission() 从 userStore.userInfo.permissions 获取权限列表
  → hasPermission('permission:code') 检查是否包含权限
  → v-if="hasPermission('xxx')" 控制按钮/菜单显示
```

## 三、权限代码规范

### 命名规则
- 格式：`模块:操作` 或 `模块:子模块:操作`
- 示例：
  - `system:user:view` - 系统管理-用户-查看
  - `plan:add` - 计划-新增
  - `yield:evidence:delete` - 产量-凭证-删除

### 权限代码列表

#### 系统管理
- `system:user:view` - 用户查看
- `system:user:add` - 用户新增
- `system:user:edit` - 用户编辑
- `system:user:delete` - 用户删除
- `system:user:reset` - 用户密码重置
- `system:user:approve` - 用户审核
- `system:role:view` - 角色查看
- `system:role:add` - 角色新增
- `system:role:edit` - 角色编辑
- `system:role:delete` - 角色删除
- `system:permission:view` - 权限查看
- `system:permission:add` - 权限新增
- `system:permission:edit` - 权限编辑
- `system:permission:delete` - 权限删除

#### 部门管理
- `department:view` - 部门查看
- `department:add` - 部门新增
- `department:edit` - 部门编辑
- `department:delete` - 部门删除

#### 计划管理
- `plan:view` - 计划查看
- `plan:add` - 计划新增
- `plan:edit` - 计划编辑
- `plan:delete` - 计划删除
- `plan:approve` - 计划审批

#### 产量管理
- `yield:view` - 产量查看
- `yield:add` - 产量新增
- `yield:edit` - 产量编辑
- `yield:delete` - 产量删除
- `yield:audit` - 产量审核
- `yield:evidence:view` - 产量凭证查看
- `yield:evidence:add` - 产量凭证新增
- `yield:evidence:delete` - 产量凭证删除

#### 其他模块
- `log:view` - 操作日志查看
- `statistics:view` - 统计分析查看
- `message:send` - 消息发送

## 四、前端使用示例

### 1. 在组件中使用权限判断

```vue
<script setup>
import { usePermission } from '@/composables/usePermission'

const { hasPermission } = usePermission()
</script>

<template>
  <!-- 按钮权限控制 -->
  <el-button v-if="hasPermission('plan:add')" @click="handleAdd">
    新增计划
  </el-button>
  
  <el-button v-if="hasPermission('plan:edit')" @click="handleEdit">
    编辑
  </el-button>
  
  <el-button v-if="hasPermission('plan:delete')" @click="handleDelete">
    删除
  </el-button>
</template>
```

### 2. 在路由中使用权限判断

```javascript
// router/index.js
import { hasRole } from '@/constants/role'

router.beforeEach((to, from, next) => {
  // 路由级别的权限控制（基于角色名称）
  if (to.meta.roles && userStore.userInfo) {
    const userRoleName = userStore.userInfo.roleName
    if (!hasRole(to.meta.roles, userRoleName)) {
      ElMessage.warning('您没有权限访问该页面')
      next('/dashboard')
      return
    }
  }
  next()
})
```

### 3. 在菜单中使用权限判断

```vue
<!-- layout/Index.vue -->
<el-menu-item 
  index="/user" 
  v-if="canAccess([ROLE_NAMES.ADMIN])"
>
  用户管理
</el-menu-item>
```

## 五、前后端联动要点

### 1. 权限代码必须一致
- 前端使用的权限代码必须与后端 `sys_permission.permission_code` 完全一致
- 建议：在常量文件中统一管理权限代码

### 2. 权限数据同步
- 登录时后端返回权限列表，前端保存到 `userStore.userInfo.permissions`
- 每次请求时，后端从数据库重新查询权限（确保实时性）

### 3. 双重校验
- **前端校验**：控制 UI 显示/隐藏，提升用户体验
- **后端校验**：确保安全性，防止绕过前端直接调用 API

### 4. 权限变更处理
- 当管理员修改角色权限后，用户需要重新登录才能获取最新权限
- 或者实现权限刷新接口，前端主动刷新权限列表

## 六、最佳实践

1. **统一权限代码管理**
   - 创建 `constants/permission.js` 统一管理所有权限代码
   - 避免硬编码权限字符串

2. **权限代码命名规范**
   - 使用清晰的模块:操作格式
   - 保持命名一致性

3. **前端按钮控制**
   - 所有操作按钮都应使用 `v-if="hasPermission('xxx')"` 控制
   - 避免使用硬编码的角色ID判断

4. **后端接口保护**
   - 所有需要权限的接口都应添加 `@RequiresPermission` 注解
   - 不要依赖前端权限判断作为唯一安全措施

5. **权限粒度**
   - 权限应该足够细粒度，支持灵活的权限组合
   - 避免过于粗粒度的权限（如只有"管理员"和"普通用户"）

